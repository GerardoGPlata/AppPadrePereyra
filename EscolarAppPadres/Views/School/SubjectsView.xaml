<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:syncfusionPopup="clr-namespace:Syncfusion.Maui.Popup;assembly=Syncfusion.Maui.Popup"
             xmlns:controls="clr-namespace:EscolarAppPadres.Controls;assembly=EscolarAppPadres"
             x:Class="EscolarAppPadres.Views.School.SubjectsView"
             Title="ESCOLAR"
             BackgroundColor="#f5f8fa"
             Padding="{OnPlatform iOS='0,20,0,0', Android='0'}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Capa principal con el contenido -->
        <RefreshView x:Name="refreshView"
                     Grid.Row="0"
                     Command="{Binding LoadSubjectsCommand}"
                     IsRefreshing="{Binding IsRefreshing}">
            <CollectionView x:Name="collectionView"
                            ItemsSource="{Binding StudentSubjects}"
                            SelectionMode="None"
                            Margin="{OnPlatform iOS='15,20,15,15', Android='15'}">
                <CollectionView.EmptyView>
                    <Label Text="No se encontraron materias"
                           FontSize="16"
                           TextColor="Gray"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Margin="0,20"/>
                </CollectionView.EmptyView>
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical"
                                       ItemSpacing="{OnPlatform iOS='15', Android='10'}"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame BackgroundColor="White"
                               CornerRadius="16"
                               HasShadow="True"
                               Margin="{OnPlatform iOS='0,5,0,5', Android='0,5'}"
                               Padding="20">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={x:Reference collectionView}, Path=BindingContext.SubjectTappedCommand}"
                                    CommandParameter="{Binding .}"/>
                            </Frame.GestureRecognizers>

                            <Grid ColumnDefinitions="*,Auto"
                                  RowDefinitions="Auto,Auto">
                                <Label Text="{Binding Materia}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#273840"
                                       TextTransform="Uppercase"
                                       Grid.Row="0"
                                       Grid.Column="0"/>

                                <Label Text="{Binding Profesor, StringFormat='Prof. {0}'}"
                                       FontSize="14"
                                       FontAttributes="Italic"
                                       TextColor="Gray"
                                       Margin="0,4,0,0"
                                       Grid.Row="1"
                                       Grid.Column="0"/>

                                <Image Source="chevron_right"
                                       WidthRequest="18"
                                       HeightRequest="18"
                                       HorizontalOptions="End"
                                       VerticalOptions="Center"
                                       Grid.RowSpan="2"
                                       Grid.Column="1"
                                       Margin="8,0,0,0"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Picker abajo sin superponer -->
        <Frame Grid.Row="1"
               BackgroundColor="#008347"
               CornerRadius="20"
               HasShadow="True"
               Padding="10,4"
               Margin="0,0,0,25"
               HeightRequest="50"
               MinimumWidthRequest="320"
               WidthRequest="{OnIdiom Phone=340, Tablet=480, Desktop=420}"
               HorizontalOptions="Center"
               VerticalOptions="End">
            <Grid ColumnDefinitions="*,Auto"
                  VerticalOptions="Center"
                  HeightRequest="44">
                <controls:ChildPicker Title="Seleccionar hijo"
                                      ItemsSource="{Binding Hijos}"
                                      ItemDisplayBinding="{Binding NombreCompleto}"
                                      SelectedItem="{Binding SelectedHijo}"
                                      FontSize="13"
                                      FontAttributes="Bold"
                                      TextColor="White"
                                      TitleColor="White"
                                      HorizontalOptions="Fill"
                                      Margin="0,0,4,0"/>
                <Image Source="chevron_down_white"
                       Grid.Column="1"
                       WidthRequest="18"
                       HeightRequest="18"
                       VerticalOptions="Center"
                       HorizontalOptions="End"
                       Margin="4,0,4,0"/>
            </Grid>
        </Frame>

        <!-- Popup -->
        <syncfusionPopup:SfPopup x:Name="sfPopup"
                                 Grid.RowSpan="2"
                                 StaysOpen="True"
                                 OverlayMode="Blur"
                                 ShowCloseButton="True"
                                 IsOpen="False"
                                 AutoSizeMode="Height"
                                 AnimationMode="Fade"
                                 WidthRequest="312"
                                 HeightRequest="250"
                                 HeaderHeight="70"
                                 HeaderTitle="Tareas">
            <syncfusionPopup:SfPopup.PopupStyle>
                <syncfusionPopup:PopupStyle HeaderBackground="#273840"
                                            HeaderFontSize="14"
                                            HeaderTextColor="White"
                                            PopupBackground="White"
                                            CloseButtonIcon="close_icon"
                                            BlurIntensity="Dark"/>
            </syncfusionPopup:SfPopup.PopupStyle>
            <syncfusionPopup:SfPopup.ContentTemplate>
                <DataTemplate>
                    <ScrollView Padding="10">
                        <Label Text="{Binding PopupContent}"
                               TextColor="#49454E"
                               BackgroundColor="White"
                               FontSize="14"
                               LineBreakMode="WordWrap"/>
                    </ScrollView>
                </DataTemplate>
            </syncfusionPopup:SfPopup.ContentTemplate>
        </syncfusionPopup:SfPopup>
    </Grid>
</ContentPage>